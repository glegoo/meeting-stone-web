# 01 PRD：Meeting Stone Web（多游戏组队平台）

## 1. 背景与目标

微信小程序的“集合石/组队工具”在国内效果很好，但 Web 场景无法限制转发、用户来源更分散、且未来要支持多游戏（WoW、FF14 等 MMO/组队游戏）。本 PRD 定义 Web 版的产品边界与 MVP，并给出可扩展到多游戏的产品与数据原则。

## 2. 范围（MVP）

### 2.1 必须包含

- **活动/模板**
  - 创建/编辑/删除活动
  - 模板管理（创建/编辑/删除/导入模板到活动）
  - 子活动（lineup_list）：支持多车/多时段活动（如"周六 ICC25H"+"周日 ICC10H"）
  - 人员限制：
    - 总量限制（Any/Any）
    - 职责限制（坦克/治疗/输出）
    - 职业限制（战士、圣骑士...）
    - 专长限制（防护战、武器战...）
    - 禁止报名（限制数=0）
- **大厅（公开活动）**
  - 搜索：服务器/阵营（若该游戏存在）、日期、规模、关键词
  - 列表分页、无限滚动
- **活动详情**
  - 活动头部：标题、团长信息、统计（坦克/治疗/输出人数、平均分数、平均装等）
  - 报名列表：按职业分组、左右联动滚动
  - 限制查看弹窗：显示各限制的当前人数与上限
  - 日志查看：报名/请假/取消/阵容变更等操作记录
  - 举报功能：活动违规举报（预留 v1.1）
- **报名**
  - 单角色报名：
    - 绑定角色报名（从收藏角色列表选择）
    - 自定义报名（手动输入角色名/职业/天赋）
    - 双天赋选择（主天赋 + 副天赋）
    - 备注信息、联系方式（仅团长可见）
    - 指定可参加的车队（lineup_allow_list）
  - 报名组（Signup Group）：
    - 创建/编辑/删除报名组
    - 报名组包含多个角色（姓名、职业、天赋）
    - 批量报名：一键报名组内所有角色
- **阵容编排**
  - 多阵容支持：添加/删除阵容（第1车、第2车...）
  - 拖拽排位：网格布局（5列 x N行），拖拽移动/交换位置
  - 角色筛选面板：按职责/职业/适配状态筛选
  - 统计展示：
    - 职责统计（坦克/治疗/输出数量，含副天赋统计）
    - 平均分数/装等
    - 团队Buff覆盖情况（WoW CTM/MOP/正式服）
  - 重复用户检测：同一账号在同一阵容中的多个角色高亮提示
  - 未指定本车提示：角色指定了其他车队但未指定本车时警告
  - 复制名单：导出 MRT 格式名单
  - 保存/批量保存
  - **AI 排班**：
    - 配置阵容模板（每个位置指定：任意/职责/职业/天赋/空位）
    - 一键自动填充所有阵容
    - 结果不自动保存，需手动确认
  - 显示昵称切换：角色名/用户昵称切换显示
- **社交与协作**
  - 关注：关注其他用户，快速查看其活动
  - 黑名单：屏蔽用户，其报名将被拒绝
  - 活动管理员（assistant）：
    - 邀请/接受/解除管理员
    - 权限：协助管理报名/阵容编排
- **访问控制（Web 必须补齐）**
  - 活动访问码（Access Code）
  - 可撤销/可过期邀请链接（Invite Link）
- **通知（MVP=Email）**
  - 截止提醒
  - 管理员邀请/接受/解除
  - 报名状态变更（请假/取消/被移除）
  - 活动变更（标题/描述/时间/公开性/访问控制变化）

### 2.2 暂不做（v1.1+）

- 举报与审核后台（但 v1 需要预留接口与数据结构）
- Discord 通知、Web Push（PWA）
- 实时协作（WebSocket 多人同时编辑阵容）

## 3. 多游戏产品原则（关键）

### 3.1 活动必须属于一个游戏（activity-scoped）

- 每个活动/模板/报名/阵容/报名组都必须有 `gameKey`。
- UI、校验、筛选字段、评分体系都由该 `gameKey` 决定。

### 3.2 UI 由 Game Manifest 驱动

- Web 不写死“职业/天赋/阵营/服务器/规模”等 WoW 概念。
- 前端通过 `GET /api/v1/games/{gameKey}/manifest` 获取：
  - 职责体系（roles）
  - 职业与专长（jobs/specs）
  - 图标与颜色（icons/colors）
  - 团队规模与编队形态（party sizes / roster shape）
  - 是否启用服务器/阵营过滤、是否启用 buff/团队组件展示

## 4. 角色与权限

### 4.1 角色

- **Owner（团长）**：活动全权限（编辑活动、管理报名、编排阵容、查看联系方式、邀请管理员、生成访问码/邀请链接）
- **Assistant（管理员）**：协助管理报名/阵容（范围可配置：仅阵容/仅报名/全协助）
- **Participant（团员）**：报名、请假/取消自己的报名、查看活动公开信息
- **Visitor（访客）**：只读访问（受访问控制影响）

### 4.2 权限规则（摘要）

- 联系方式展示：仅 Owner/Assistant 可见（且报名者需勾选“显示联系方式给团长”）
- 活动编辑：仅 Owner（MVP），后续可扩展为 Owner 授权 Assistant 编辑部分字段
- 阵容保存：Owner/Assistant

## 5. 活动可见性与访问控制（Web 版补齐）

### 5.1 可见性（是否出现在大厅）

- **公开活动**：可在大厅出现（`is_public=1`）
- **非公开活动**：不出现在大厅，只能通过链接访问

### 5.2 访问控制（是否允许查看详情/报名）

Web 无法限制链接传播，因此“仅限团长转发”升级为可撤销访问控制：

- **访问码（Access Code）**
  - 创建活动时可开启
  - 未通过校验的用户访问活动详情，需要输入访问码
  - 访问码可重置（重置后旧访问码失效）
- **邀请链接（Invite Link）**
  - Owner 可生成多条邀请链接（可命名、可设置有效期、可随时撤销）
  - 打开邀请链接可免输访问码（或完成一次性换取会话）
  - 用于“精准分发”，防止访问码在群内扩散后无法回收

### 5.3 访问控制与大厅关系

建议规则（避免公开活动被“窥探”）：
- 若活动为公开但开启访问码：大厅可见，但 **进入详情需要访问码/邀请链接**（标题等可显示摘要级信息）。

## 6. 核心流程（用户旅程）

### 6.1 团长：创建活动 → 管控报名 → 编排阵容 → 通知

1. 选择游戏（game）与模板（可选）
2. 填写标题/描述/截止时间/规模
3. 配置人员限制（总量/职责/职业/专长）
4. 配置可见性（是否公开）与访问控制（访问码/邀请链接）
5. 发布后：
   - 查看报名列表、按职业/职责分组
   - 邀请管理员协作
   - 进入阵容页拖拽排位 / AI 排班 / 保存
   - 触发 Email 通知（活动变更、截止提醒等）

### 6.2 团员：大厅找团/链接进入 → 报名

1. 搜索/筛选活动
2. 进入活动详情（若需要则输入访问码）
3. 报名方式：
   - 单角色报名（可选绑定角色/自定义）
   - 报名组批量报名
4. 后续可请假/取消

## 7. 关键业务规则

### 7.1 报名限制（通用规则）

- 总名额限制（Any/Any）
- 职责限制（如 Tanks/Healers/DPS，或近战/远程等，取决于 game manifest）
- 职业限制（job）
- 专长限制（spec）
- **限制优先级**：专长 > 职业 > 职责 > 总量
- **限制数=0 表示禁止**：该类型角色不可报名

### 7.2 阵容规则（通用规则）

- 同一账号（uid）在同一车中尽量不重复（硬性/软性取决于 game 规则，MVP 先做强提示）
- 报名时可指定可参加的车队（`lineup_list_str`），排班与筛选需要遵守
- **可选角色**：未指定车队 或 指定了本车 的角色
- **指定本车角色**：明确指定了本车的角色
- **未指定本车角色**：指定了其他车队但未指定本车的角色（警告提示）

### 7.3 模板规则

- 模板保存：标题、描述、规模、子活动列表、人员限制、服务器/阵营、可见性设置
- 模板导入：创建活动时可导入模板，自动填充表单（可修改）
- 模板不保存：截止时间（每次活动不同）

### 7.4 子活动（车队）规则

- 活动可包含多个子活动（如周六第1车、周日第2车）
- 子活动信息：时间段（周几 + 时间）+ 描述（如"ICC25H上层"）
- 报名时可选择参加哪些子活动
- 阵容编排按子活动分别管理

### 7.5 分数与装等规则

- WoW 分数来源：WCL AllStar 百分位
- 分数颜色编码：100=金、99-95=橙、94-75=紫、74-50=蓝、49-25=绿、<25=灰
- 分数 ≥ 1000：表示已击杀硬核模式（显示时减去 1000）
- 装等：从角色绑定的游戏数据获取

### 7.6 团队Buff规则（WoW CTM/MOP/正式服）

- 根据阵容中的职业/专长统计团队Buff覆盖情况
- 显示已激活/未激活的Buff类型
- 点击未激活Buff可筛选能提供该Buff的角色

## 8. 通知系统（MVP=Email）

### 8.1 事件

- **截止提醒**
- **管理员邀请/接受/解除**
- **报名状态变更**：请假/取消/被移除
- **活动变更**：标题/描述/时间/公开性/访问控制变化

### 8.2 收件人规则（MVP）

- 活动变更：已报名用户 + 管理员（可按变更类型筛选，仅“时间/截止”触发）
- 状态变更：仅当事人；“被移除”可同时通知 Owner（可配置）
- 管理员邀请：仅被邀请人；接受/解除通知双方
- 截止提醒：报名状态=1 且活动未过期的报名者；可选通知 Owner

### 8.3 频控与退订

- 每类事件独立开关
- 合并/去抖：同一活动 5 分钟内多次变更合并为摘要
- 限速：单用户每小时/每天上限；同一活动提醒次数上限

### 8.4 时区与语言

- 邮件时间展示按用户 profile 时区（默认浏览器时区）
- 模板支持 en/zh（后续可扩展更多语言）

## 9. 非功能需求

- **时区**：数据库统一存 UTC；搜索“活动日期”需明确按用户时区还是活动时区（建议按用户时区）
- **反滥用**：登录/报名/访问码输入需要限流；后续可接验证码
- **隐私**：联系方式、Email 等必须最小暴露（只给有权限角色）

## 10. 指标（用于验证 MVP）

- 公开大厅：搜索转化率（列表 → 详情）
- 报名转化率（详情 → 报名成功）
- 成团效率：阵容保存次数、AI 排班使用率
- 通知有效性：截止提醒打开率、退订率、投诉率

